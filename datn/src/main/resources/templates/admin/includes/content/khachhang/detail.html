<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery.validation/1.19.5/jquery.validate.min.js"></script>
    <script>
        $(document).ready(function () {
            function getProvinces() {
                $.ajax({
                    url: 'https://online-gateway.ghn.vn/shiip/public-api/master-data/province',
                    type: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Token': 'c00660e2-2e4f-11ef-8f55-4ee3d82283af'
                    },
                    success: function (response) {
                        if (response.code === 200) {
                            $("#province").append('<option value="">Chọn Thành Phố</option>');
                            $.each(response.data, function (key, value) {
                                $("#province").append('<option value="' + value.ProvinceID + '">' + value.ProvinceName + '</option>');
                            });
                        } else {
                            console.error('Error fetching provinces:', response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('AJAX error:', status, error);
                        console.error('Response text:', xhr.responseText);
                    }
                });
            }

            function getDistricts(provinceId) {
                $.ajax({
                    url: 'https://online-gateway.ghn.vn/shiip/public-api/master-data/district?province_id=' + provinceId,
                    type: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Token': 'c00660e2-2e4f-11ef-8f55-4ee3d82283af'
                    },
                    success: function (response) {
                        if (response.code === 200) {
                            $("#district").html('<option value="">Chọn Huyện</option>');
                            $("#ward").html('<option value="">Chọn Xã</option>');
                            $.each(response.data, function (key, value) {
                                $("#district").append('<option value="' + value.DistrictID + '">' + value.DistrictName + '</option>');
                            });
                        } else {
                            console.error('Error fetching districts:', response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('AJAX error:', status, error);
                        console.error('Response text:', xhr.responseText);
                    }
                });
            }

            function getWards(districtId) {
                $.ajax({
                    url: 'https://online-gateway.ghn.vn/shiip/public-api/master-data/ward?district_id=' + districtId,
                    type: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Token': 'c00660e2-2e4f-11ef-8f55-4ee3d82283af'
                    },
                    success: function (response) {
                        if (response.code === 200) {
                            $("#ward").html('<option value="">Chọn Xã</option>');
                            $.each(response.data, function (key, value) {
                                $("#ward").append('<option value="' + value.WardCode + '">' + value.WardName + '</option>');
                            });
                        } else {
                            console.error('Error fetching wards:', response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('AJAX error:', status, error);
                        console.error('Response text:', xhr.responseText);
                    }
                });
            }

            getProvinces();

            $("#province").on('change', function () {
                const provinceId = $(this).val();
                const provinceName = $("#province option:selected").text();
                if (provinceId) {
                    getDistricts(provinceId);
                    $("#provinceName").val(provinceName);
                } else {
                    $("#district").html('<option value="">Chọn Huyện</option>');
                    $("#ward").html('<option value="">Chọn Xã</option>');
                    $("#provinceName").val('');
                }
            });

            $("#district").on('change', function () {
                const districtId = $(this).val();
                const districtName = $("#district option:selected").text();
                if (districtId) {
                    getWards(districtId);
                    $("#districtName").val(districtName);
                } else {
                    $("#ward").html('<option value="">Chọn Xã</option>');
                    $("#districtName").val('');
                }
            });

            $("#ward").on('change', function () {
                const wardId = $(this).val();
                const wardName = $("#ward option:selected").text();
                $("#wardName").val(wardName);
            });

        });

    </script>



    <script>
        $(document).ready(function() {
            // Thêm phương thức tùy chỉnh để kiểm tra khoảng trắng liên tiếp và khoảng trắng ở đầu/cuối
            $.validator.addMethod("noWhitespace", function(value, element) {
                var trimmedValue = $.trim(value);
                var noConsecutiveSpaces = !/\s{2,}/.test(trimmedValue);
                return trimmedValue === value && noConsecutiveSpaces;
            }, "Không được chứa khoảng trắng liên tiếp hoặc khoảng trắng ở đầu/cuối.");

            $.validator.addMethod("noSpecialChars", function(value, element) {
                return /^[a-zA-Z0-9\sàáảãạăằắẳẵặâầấẩẫậèéẻẽẹêềếểễệìíỉĩịòóỏõọôồốổỗộơờớởỡợùúủũụưừứửữựỳýỷỹỵĐđ]*$/.test(value);
            }, "Không được chứa ký tự đặc biệt.");

            // Phương thức tùy chỉnh để kiểm tra xem giá trị có hợp lệ không (không được là "0")
            $.validator.addMethod("validSelection", function(value, element) {
                return value !== "0";
            }, "Vui lòng chọn một giá trị hợp lệ.");

            // Kiểm tra nếu form đang ở trạng thái thêm địa chỉ
            var formType = $('input[name="formType"]').val();
            if (formType === 'add') {
                $("#address-form").validate({
                    rules: {

                        'sdt': {
                            required: true,
                            digits: true,
                            minlength: 10,
                            maxlength: 15
                        },
                        'email': {
                            required: true,
                            email: true
                        },
                        'ngaySinh': {
                            required: true,
                            dateISO: true // Định dạng ngày là yyyy-mm-dd
                        },
                        'diaChiList[0].thanhPho': {
                            required: true,
                            validSelection: true // Kiểm tra giá trị hợp lệ
                        },
                        'diaChiList[0].huyen': {
                            required: true,
                            validSelection: true
                        },
                        'diaChiList[0].xa': {
                            required: true,
                            validSelection: true
                        },
                        'diaChiList[0].diaChi': {
                            required: true,
                            minlength: 5,
                            noWhitespace: true,
                            noSpecialChars: true
                        },
                        'diaChiList[0].ten': {
                            required: true,
                            minlength: 2,
                            noWhitespace: true,
                            noSpecialChars: true
                        },
                        'diaChiList[0].sdt': {
                            required: true,
                            digits: true,
                            minlength: 10,
                            maxlength: 15
                        },
                        'diaChiList[0].email': {
                            required: true,
                            email: true // Validate email format
                        }
                    },
                    messages: {
                        'hoTen': {
                            required: "Vui lòng nhập họ tên.",
                            minlength: "Họ tên phải có ít nhất 2 ký tự.",
                            maxlength: "Họ tên không được vượt quá 100 ký tự.",
                            noWhitespace: "Họ tên không được chứa khoảng trắng liên tiếp hoặc khoảng trắng ở đầu/cuối.",
                            noSpecialChars: "Họ tên không được chứa ký tự đặc biệt."
                        },
                        'sdt': {
                            required: "Vui lòng nhập số điện thoại.",
                            digits: "Số điện thoại chỉ chứa các ký tự số.",
                            minlength: "Số điện thoại phải có ít nhất 10 ký tự.",
                            maxlength: "Số điện thoại không được vượt quá 15 ký tự."
                        },
                        'email': {
                            required: "Vui lòng nhập email.",
                            email: "Vui lòng nhập địa chỉ email hợp lệ."
                        },
                        'ngaySinh': {
                            required: "Vui lòng nhập ngày sinh.",
                            dateISO: "Vui lòng nhập ngày sinh hợp lệ (định dạng yyyy-mm-dd)."
                        },
                        'diaChiList[0].thanhPho': {
                            required: "Vui lòng chọn thành phố.",
                            validSelection: "Vui lòng chọn thành phố hợp lệ."
                        },
                        'diaChiList[0].huyen': {
                            required: "Vui lòng chọn huyện.",
                            validSelection: "Vui lòng chọn huyện hợp lệ."
                        },
                        'diaChiList[0].xa': {
                            required: "Vui lòng chọn xã.",
                            validSelection: "Vui lòng chọn xã hợp lệ."
                        },
                        'diaChiList[0].diaChi': {
                            required: "Vui lòng nhập địa chỉ.",
                            minlength: "Địa chỉ phải có ít nhất 5 ký tự.",
                            noWhitespace: "Địa chỉ không được chứa khoảng trắng liên tiếp hoặc khoảng trắng ở đầu/cuối.",
                            noSpecialChars: "Địa chỉ không được chứa ký tự đặc biệt."
                        },
                        'diaChiList[0].ten': {
                            required: "Vui lòng nhập tên người nhận.",
                            minlength: "Tên người nhận phải có ít nhất 2 ký tự.",
                            noWhitespace: "Tên không được chứa khoảng trắng liên tiếp hoặc khoảng trắng ở đầu/cuối.",
                            noSpecialChars: "Tên không được chứa ký tự đặc biệt."
                        },
                        'diaChiList[0].sdt': {
                            required: "Vui lòng nhập số điện thoại.",
                            digits: "Số điện thoại chỉ chứa các ký tự số.",
                            minlength: "Số điện thoại phải có ít nhất 10 ký tự.",
                            maxlength: "Số điện thoại không được vượt quá 15 ký tự."
                        },
                        'diaChiList[0].email': {
                            required: "Vui lòng nhập email.",
                            email: "Vui lòng nhập địa chỉ email hợp lệ."
                        }
                    },
                    errorElement: "div",
                    errorPlacement: function(error, element) {
                        error.addClass("text-red-500 text-sm mt-1");
                        error.insertAfter(element);
                    }
                });
            }
        });
    </script>

    <script>
        function confirmAddAddress() {
            return confirm("Bạn có chắc chắn muốn thêm địa chỉ này không?");
        }
    </script>
    <script>
        function confirmUpdateStatus() {
            return confirm("Bạn có chắc chắn muốn cập nhật trạng thái địa chỉ này không?");
        }
    </script>
    <script>
        function closeAlert(alertId) {
            var alertElement = document.getElementById(alertId);
            if (alertElement) {
                alertElement.style.display = 'none';
            }
        }
    </script>
    <script>
        function closeAlert(alertId) {
            var alertElement = document.getElementById(alertId);
            if (alertElement) {
                alertElement.style.display = 'none';
            }
        }
        // Tự động ẩn thông báo sau 3 giây (3000 milliseconds)
        setTimeout(function() {
            closeAlert('successAlert');
        }, 3000);

        setTimeout(function() {
            closeAlert('dangerAlert');
        }, 3000);
    </script>

</head>
<body>
<div layout:fragment="admincontent">
    <div th:if="${error1}" class="alert alert-danger">
        <p th:text="${error1}"></p>
    </div>
    <div th:if="${message3}" class="alert alert-success">
        <p th:text="${message3}"></p>
    </div>
    <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert" id="successAlert">
        <span th:text="${message}"></span>
        <button type="button" class="close" aria-label="Close" onclick="closeAlert('successAlert')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div th:if="${message1}" class="alert alert-danger alert-dismissible fade show" role="alert" id="dangerAlert">
        <span th:text="${message1}"></span>
        <button type="button" class="close" aria-label="Close" onclick="closeAlert('dangerAlert')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div th:if="${messageError}" class="alert alert-danger">
        <p th:text="${messageError}"></p>
    </div>
    <div class="mb-6 flex justify-between text-center gap-3 sm:flex-row sm:items-center sm:justify-between">
        <h3 class="text-title-md2 font-semibold text-black dark:text-white"
            th:text="${khachHang.khachHangId == null} ? 'Thêm Khách Hàng' : 'Chi Tiết Khách Hàng'">
        </h3>
        <div class="btn btn-sm bg-sky-50 hover:bg-sky-100 text-sky-800">
            <a th:href="@{/admin/taikhoan/khachhang}" class="custom-button">Quay lại</a>
        </div>
    </div>
    <section class="relative md:py-10 bg-white px-25">
        <div class="grid lg:grid-cols-12 gap-6 w-full">
            <div class="lg:col-span-8">
                <div class="p-6 rounded-md">
                    <form th:action="@{/admin/taikhoan/khachhang/updateDiaChi}" th:object="${khachHang}"
                          method="post" onsubmit="return confirmAddAddress();" id="address-form">
                        <input type="hidden" name="formType" value="add">
                        <div class="grid lg:grid-cols-12 grid-cols-1 mt-6 gap-5">
                            <input type="hidden" th:field="*{khachHangId}"/>
                            <div class="lg:col-span-6">
                                <label class="form-label font-semibold">Tên Khách Hàng: </label>
                                <input type="text" th:field="*{hoTen}"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Tên Khách Hàng" readonly>
                                <div th:if="${#fields.hasErrors('hoTen')}" th:errors="*{hoTen}"
                                     class="text-red-500 text-sm mt-1"></div>
                            </div>
                            <div class="lg:col-span-6">
                                <label class="form-label font-semibold">Số Điện Thoại:</label>
                                <input type="text" th:field="*{sdt}"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Số Điện Thoại" readonly>
                                <div th:if="${#fields.hasErrors('sdt')}" th:errors="*{sdt}"
                                     class="text-red-500 text-sm mt-1"></div>
                            </div>
                            <div class="lg:col-span-6">
                                <label class="form-label font-semibold">Email: </label>
                                <input type="email" th:field="*{email}"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Email" readonly>
                                <div th:if="${#fields.hasErrors('email')}" th:errors="*{email}"
                                     class="text-red-500 text-sm mt-1"></div>
                            </div>
                            <div class="lg:col-span-6" style="display: none;">
                                <label class="form-label font-semibold">MatKhau</label>
                                <input type="text" th:field="*{password}"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="password">
                            </div>
                            <div class="lg:col-span-6">
                                <label class="form-label font-semibold">Ngày Sinh: </label>
                                <input type="date" th:field="*{ngaySinh}"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Ngày Sinh" readonly>
                                <div th:if="${#fields.hasErrors('ngaySinh')}" th:errors="*{ngaySinh}"
                                     class="text-red-500 text-sm mt-1"></div>
                            </div>
                            <div class="lg:col-span-12">
                                <label class="form-label font-medium block text-gray-700">Giới tính</label>
                                <div class="mt-1 flex items-center space-x-4 px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                    <label class="inline-flex items-center">
                                        <input type="radio" th:field="*{gioiTinh}" value="false"
                                               class="form-radio text-indigo-600 focus:ring-indigo-500 focus:border-indigo-500"
                                               disabled />
                                        <span class="ml-2">Nữ</span>
                                    </label>
                                    <label class="inline-flex items-center ml-4">
                                        <input type="radio" th:field="*{gioiTinh}" value="true"
                                               class="form-radio text-indigo-600 focus:ring-indigo-500 focus:border-indigo-500"
                                               disabled />
                                        <span class="ml-2">Nam</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <h3 class="text-title-md2 font-semibold mt-12"> Thêm Địa Chỉ</h3>
                        <div class="grid lg:grid-cols-12 grid-cols-1 mt-6 gap-5">
                            <div class="lg:col-span-4">
                                <label class="font-semibold">Thành Phố:</label>
                                <select id="province" name="diaChiList[0].thanhPho"
                                        class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2">
                                    <option value="">Tỉnh Thành</option>
                                </select>
                            </div>
                            <div class="lg:col-span-4">
                                <label class="font-semibold">Huyện:</label>
                                <select id="district" name="diaChiList[0].huyen"
                                        class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2">
                                    <option value="">Quận Huyện</option>
                                </select>
                            </div>
                            <div class="lg:col-span-4">
                                <label class="font-semibold">Xã:</label>
                                <select id="ward" name="diaChiList[0].xa"
                                        class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2">
                                    <option value="">Phường Xã</option>
                                </select>
                            </div>
                            <div class="lg:col-span-12">
                                <label class="form-label font-semibold">Địa Chỉ: </label>
                                <input type="text" name="diaChiList[0].diaChi"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Địa Chỉ">
                                <div th:if="${#fields.hasErrors('diaChiList[0].diaChi')}" class="text-danger" th:errors="*{diaChiList[0].diaChi}">Địa chỉ chi tiết không được để trống.</div>
                            </div>
                            <div class="lg:col-span-12">
                                <label class="form-label font-semibold">Tên Người Nhận: </label>
                                <input type="text" name="diaChiList[0].ten"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Tên Người Nhận">
                            </div>
                            <div class="lg:col-span-12">
                                <label class="form-label font-semibold">Email: </label>
                                <input type="text" name="diaChiList[0].email"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Email người nhận">
                            </div>
                            <div class="lg:col-span-12">
                                <label class="form-label font-semibold">Số điện thoại: </label>
                                <input type="text" name="diaChiList[0].sdt"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Số điện thoại người nhận">
                            </div>
                            <div class="lg:col-span-12 mt-4 flex items-center justify-center mb-4">
                                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md">Lưu</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>
    <div class="bg-white">
        <table class="table-default table-hover data-table">
            <thead>
            <tr>
                <th>Tên Người Nhận</th>
                <th>Số Điện Thoại Người Nhận</th>
                <th>Email Người Nhận</th>
                <th>Tỉnh/Thành Phố</th>
                <th>Quận/Huyện</th>
                <th>Phường/Xã</th>
                <th>Địa Chỉ</th>
                <th>Hành Động</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="diaChi : ${khachHang.diaChiList}">
                <td th:text="${diaChi.ten}"></td>
                <td th:text="${diaChi.sdt}"></td>
                <td th:text="${diaChi.email}"></td>

                <!-- Tỉnh/Thành Phố -->
                <td class="tinhThanhPho" th:attr="data-province-id=${diaChi.thanhPho}"></td>

                <!-- Quận/Huyện -->
                <td class="huyenQuan" th:attr="data-district-id=${diaChi.huyen}"></td>

                <!-- Phường/Xã -->
                <td class="xaPhuong" th:attr="data-ward-code=${diaChi.xa}"></td>

                <td th:text="${diaChi.diaChi}"></td>

                <td>
                    <a th:href="@{/admin/taikhoan/diaChi/delete/{id}(id=${diaChi.diaChiId}, khachHangId=${khachHang.khachHangId})}"
                       onclick="return confirm('Bạn có chắc chắn muốn xóa địa chỉ này không?');">Xóa</a>
                </td>
            </tr>
            </tbody>
        </table>

    </div>
</div>
</body>
</html>
<!--<td th:text="${diaChi.huyen}" class="huyenQuan"></td>-->
<!--<td th:text="${diaChi.xa}" class="xaPhuong"></td>-->

<script>
    // Lưu trữ dữ liệu xã theo từng huyện
    const districtWardsMap = new Map();

    // Hàm để lấy dữ liệu tỉnh/thành phố từ API
    function fetchProvinces() {
        return fetch('https://online-gateway.ghn.vn/shiip/public-api/master-data/province', {
            headers: {
                'Token': 'c00660e2-2e4f-11ef-8f55-4ee3d82283af'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (!data || !data.data || !Array.isArray(data.data)) {
                throw new Error('Dữ liệu tỉnh/thành phố không hợp lệ');
            }
            return new Map(data.data.map(province => [province.ProvinceID, province.ProvinceName]));
        })
        .catch(error => {
            console.error('Lỗi khi lấy dữ liệu tỉnh/thành phố:', error);
            return new Map(); // Trả về Map rỗng nếu có lỗi
        });
    }

    // Hàm để lấy dữ liệu quận/huyện từ API
    function fetchDistricts() {
        return fetch('https://online-gateway.ghn.vn/shiip/public-api/master-data/district', {
            headers: {
                'Token': 'c00660e2-2e4f-11ef-8f55-4ee3d82283af'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (!data || !data.data || !Array.isArray(data.data)) {
                throw new Error('Dữ liệu quận/huyện không hợp lệ');
            }
            const districtsMap = new Map(data.data.map(district => [district.DistrictID, district.DistrictName]));
            return districtsMap;
        })
        .catch(error => {
            console.error('Lỗi khi lấy dữ liệu quận/huyện:', error);
            return new Map(); // Trả về Map rỗng nếu có lỗi
        });
    }

    // Hàm để lấy dữ liệu phường/xã từ API với district_id
    function fetchWards(districtId) {
        console.log('Fetching wards for districtId:', districtId); // Hiển thị districtId

        return fetch(`https://online-gateway.ghn.vn/shiip/public-api/master-data/ward?district_id=${districtId}`, {
            headers: {
                'Token': 'c00660e2-2e4f-11ef-8f55-4ee3d82283af'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (!data || !data.data || !Array.isArray(data.data)) {
                throw new Error('Dữ liệu phường/xã không hợp lệ');
            }
            const wardMap = new Map(data.data.map(ward => [ward.WardCode, ward.WardName]));
            districtWardsMap.set(districtId, wardMap);

            // Hiển thị wardMap
            console.log('WardMap for districtId', districtId, ':', Array.from(wardMap.entries()));

            return wardMap;
        })
        .catch(error => {
            console.error('Lỗi khi lấy dữ liệu phường/xã:', error);
            return new Map(); // Trả về Map rỗng nếu có lỗi
        });
    }

    // Hàm để cập nhật tên tỉnh/thành phố, quận/huyện và phường/xã trong bảng
    function updateTableContent(provinceMap, districtMap) {
        const tinhThanhPhoElements = document.querySelectorAll('.tinhThanhPho');
        const huyenQuanElements = document.querySelectorAll('.huyenQuan');
        const xaPhuongElements = document.querySelectorAll('.xaPhuong');

        tinhThanhPhoElements.forEach(element => {
            const provinceID = parseInt(element.getAttribute('data-province-id'), 10);
            if (isNaN(provinceID)) {
                console.error('ProvinceID không hợp lệ hoặc không phải số:', element.getAttribute('data-province-id'));
                element.textContent = 'Không xác định';
                return;
            }
            const provinceName = provinceMap.get(provinceID);
            element.textContent = provinceName || 'Không xác định';
        });

        huyenQuanElements.forEach(element => {
            const districtID = parseInt(element.getAttribute('data-district-id'), 10);
            if (isNaN(districtID)) {
                console.error('DistrictID không hợp lệ hoặc không phải số:', element.getAttribute('data-district-id'));
                element.textContent = 'Không xác định';
                return;
            }
            const districtName = districtMap.get(districtID);
            element.textContent = districtName || 'Không xác định';

            // Fetch wards for each district and update xaPhuongElements
            fetchWards(districtID)
                .then(fetchedWardMap => {
                    xaPhuongElements.forEach(wardElement => {
                        const wardCode = wardElement.getAttribute('data-ward-code');
                        console.log('WardCode:', wardCode); // Hiển thị wardCode

                        if (!wardCode) {
                            console.error('WardCode không hợp lệ hoặc không có giá trị:', wardCode);
                            wardElement.textContent = 'Không xác định';
                            return;
                        }

                        // Hiển thị tất cả phường/xã cho các districtId
                        const wardName = fetchedWardMap.get(wardCode);
                        if (wardName) {
                            wardElement.textContent = wardName;
                        }
                    });
                })
                .catch(error => {
                    console.error('Lỗi khi lấy dữ liệu phường/xã cho districtID:', districtID, error);
                });
        });
    }

    // Khi trang đã được tải
    document.addEventListener('DOMContentLoaded', function() {
        Promise.all([fetchProvinces(), fetchDistricts()])
            .then(([provinceMap, districtMap]) => {
                updateTableContent(provinceMap, districtMap);
            })
            .catch(error => {
                console.error('Lỗi khi lấy dữ liệu:', error);
            });
    });


</script>
