<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://esgoo.net/scripts/jquery.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery.validation/1.19.5/jquery.validate.min.js"></script>

    <script>
        $(document).ready(function () {
            //Lấy tỉnh thành
            $.getJSON('https://esgoo.net/api-tinhthanh/1/0.htm', function (data_tinh) {
                if (data_tinh.error == 0) {
                    $.each(data_tinh.data, function (key_tinh, val_tinh) {
                        $("#tinh").append('<option value="' + val_tinh.id + '">' + val_tinh.full_name + '</option>');
                    });
                    $("#tinh").change(function (e) {
                        var idtinh = $(this).val();
                        //Lấy quận huyện
                        $.getJSON('https://esgoo.net/api-tinhthanh/2/' + idtinh + '.htm', function (data_quan) {
                            if (data_quan.error == 0) {
                                $("#quan").html('<option value="0">Quận Huyện</option>');
                                $("#phuong").html('<option value="0">Phường Xã</option>');
                                $.each(data_quan.data, function (key_quan, val_quan) {
                                    $("#quan").append('<option value="' + val_quan.id + '">' + val_quan.full_name + '</option>');
                                });
                                //Lấy phường xã
                                $("#quan").change(function (e) {
                                    var idquan = $(this).val();
                                    $.getJSON('https://esgoo.net/api-tinhthanh/3/' + idquan + '.htm', function (data_phuong) {
                                        if (data_phuong.error == 0) {
                                            $("#phuong").html('<option value="0">Phường Xã</option>');
                                            $.each(data_phuong.data, function (key_phuong, val_phuong) {
                                                $("#phuong").append('<option value="' + val_phuong.id + '">' + val_phuong.full_name + '</option>');
                                            });
                                        }
                                    });
                                });
                            }
                        });
                    });
                }
            });
        });

        $(document).ready(function () {
            // URL của API để lấy thông tin tỉnh/thành phố
            let apiUrlTinhThanh = 'https://esgoo.net/api-tinhthanh/1/0.htm';
            let apiUrlHuyen = 'https://esgoo.net/api-tinhthanh/2/';
            let apiUrlXa = 'https://esgoo.net/api-tinhthanh/3/';

            // Lưu trữ ánh xạ id với full_name
            let idToFullNameTinh = {};
            let idToFullNameHuyen = {};
            let idToFullNameXa = {};

            // Tải dữ liệu từ API tỉnh/thành phố và xây dựng ánh xạ
            $.getJSON(apiUrlTinhThanh, function (response) {
                if (response.error === 0) {
                    response.data.forEach(function (item) {
                        idToFullNameTinh[item.id] = item.full_name;
                    });
                    updateTableTinh();
                } else {
                    console.error('Error: ' + response.error);
                }
            });

            // Tải dữ liệu từ API huyện và xây dựng ánh xạ
            $('.tinhThanhPho').each(function () {
                let val_tinh = $(this).text().trim();  // Lấy giá trị của tỉnh/thành phố
                let url = `${apiUrlHuyen}${val_tinh}.htm`;

                $.getJSON(url, function (response) {
                    if (response.error === 0) {
                        response.data.forEach(function (item) {
                            idToFullNameHuyen[item.id] = item.full_name;
                        });
                        updateTableHuyen();
                    } else {
                        console.error('Error: ' + response.error);
                    }
                });
            });

            // Tải dữ liệu từ API xã và xây dựng ánh xạ
            $('.huyenQuan').each(function () {
                let val_huyen = $(this).text().trim();  // Lấy giá trị của huyện
                let url = `${apiUrlXa}${val_huyen}.htm`;

                $.getJSON(url, function (response) {
                    if (response.error === 0) {
                        response.data.forEach(function (item) {
                            idToFullNameXa[item.id] = item.full_name;
                        });
                        updateTableXa();
                    } else {
                        console.error('Error: ' + response.error);
                    }
                });
            });

            function updateTableTinh() {
                // Cập nhật bảng với dữ liệu từ idToFullNameTinh
                $('.tinhThanhPho').each(function () {
                    let $this = $(this);
                    let id = $this.text().trim();  // Lấy id từ thanhPho
                    let fullName = idToFullNameTinh[id] || id;  // Tìm full_name từ ánh xạ

                    // Cập nhật nội dung của ô
                    $this.text(fullName);
                });
            }

            function updateTableHuyen() {
                // Cập nhật bảng với dữ liệu từ idToFullNameHuyen
                $('.huyenQuan').each(function () {
                    let $this = $(this);
                    let id = $this.text().trim();  // Lấy id từ huyện
                    let fullName = idToFullNameHuyen[id] || id;  // Tìm full_name từ ánh xạ

                    // Cập nhật nội dung của ô
                    $this.text(fullName);
                });
            }

            function updateTableXa() {
                // Cập nhật bảng với dữ liệu từ idToFullNameXa
                $('.xaPhuong').each(function () {
                    let $this = $(this);
                    let val_huyen = $this.closest('tr').find('.huyenQuan').text().trim();  // Lấy giá trị của huyện
                    let id = $this.text().trim();  // Lấy id từ xã
                    let fullName = idToFullNameXa[id] || id;  // Tìm full_name từ ánh xạ

                    // Cập nhật nội dung của ô
                    $this.text(fullName);
                });
            }
        });
    </script>
    <script>
        $(document).ready(function() {
            // Thêm phương thức tùy chỉnh để kiểm tra khoảng trắng liên tiếp và khoảng trắng ở đầu/cuối
            $.validator.addMethod("noWhitespace", function(value, element) {
                var trimmedValue = $.trim(value);
                var noConsecutiveSpaces = !/\s{2,}/.test(trimmedValue);
                return trimmedValue === value && noConsecutiveSpaces;
            }, "Không được chứa khoảng trắng liên tiếp hoặc khoảng trắng ở đầu/cuối.");

            $.validator.addMethod("noSpecialChars", function(value, element) {
                return /^[a-zA-Z0-9\s]*$/.test(value); // Chỉ cho phép chữ cái, số và khoảng trắng
            }, "Không được chứa ký tự đặc biệt.");

            // Phương thức tùy chỉnh để kiểm tra xem giá trị có hợp lệ không (không được là "0")
            $.validator.addMethod("validSelection", function(value, element) {
                return value !== "0"; // Không cho phép giá trị "0"
            }, "Vui lòng chọn một giá trị hợp lệ.");

            $("form").validate({
                rules: {
                    'hoTen': {
                        required: true,
                        minlength: 2,
                        maxlength: 100,
                        noWhitespace: true,
                        noSpecialChars: true
                    },
                    'sdt': {
                        required: true,
                        digits: true,
                        minlength: 10,
                        maxlength: 15
                    },
                    'email': {
                        required: true,
                        email: true
                    },
                    'ngaySinh': {
                        required: true,
                        dateISO: true // Định dạng ngày là yyyy-mm-dd
                    },
                    'diaChiList[0].thanhPho': {
                        required: true,
                        validSelection: true // Kiểm tra giá trị hợp lệ
                    },
                    'diaChiList[0].huyen': {
                        required: true,
                        validSelection: true
                    },
                    'diaChiList[0].xa': {
                        required: true,
                        validSelection: true
                    },
                    'diaChiList[0].diaChi': {
                        required: true,
                        minlength: 5,
                        noWhitespace: true,
                        noSpecialChars: true
                    },
                    'diaChiList[0].ten': {
                        required: true,
                        minlength: 2,
                        noWhitespace: true,
                        noSpecialChars: true
                    },
                    'diaChiList[0].sdt': {
                        required: true,
                        digits: true,
                        minlength: 10,
                        maxlength: 15
                    }
                },
                messages: {
                    'hoTen': {
                        required: "Vui lòng nhập họ tên.",
                        minlength: "Họ tên phải có ít nhất 2 ký tự.",
                        maxlength: "Họ tên không được vượt quá 100 ký tự.",
                        noWhitespace: "Họ tên không được chứa khoảng trắng liên tiếp hoặc khoảng trắng ở đầu/cuối.",
                        noSpecialChars: "Họ tên không được chứa ký tự đặc biệt."
                    },
                    'sdt': {
                        required: "Vui lòng nhập số điện thoại.",
                        digits: "Số điện thoại chỉ chứa các ký tự số.",
                        minlength: "Số điện thoại phải có ít nhất 10 ký tự.",
                        maxlength: "Số điện thoại không được vượt quá 15 ký tự."
                    },
                    'email': {
                        required: "Vui lòng nhập email.",
                        email: "Vui lòng nhập địa chỉ email hợp lệ."
                    },
                    'ngaySinh': {
                        required: "Vui lòng nhập ngày sinh.",
                        dateISO: "Vui lòng nhập ngày sinh hợp lệ (định dạng yyyy-mm-dd)."
                    },
                    'diaChiList[0].thanhPho': {
                        required: "Vui lòng chọn thành phố.",
                        validSelection: "Vui lòng chọn thành phố hợp lệ."
                    },
                    'diaChiList[0].huyen': {
                        required: "Vui lòng chọn huyện.",
                        validSelection: "Vui lòng chọn huyện hợp lệ."
                    },
                    'diaChiList[0].xa': {
                        required: "Vui lòng chọn xã.",
                        validSelection: "Vui lòng chọn xã hợp lệ."
                    },
                    'diaChiList[0].diaChi': {
                        required: "Vui lòng nhập địa chỉ.",
                        minlength: "Địa chỉ phải có ít nhất 5 ký tự.",
                        noWhitespace: "Địa chỉ không được chứa khoảng trắng liên tiếp hoặc khoảng trắng ở đầu/cuối.",
                        noSpecialChars: "Địa chỉ không được chứa ký tự đặc biệt."
                    },
                    'diaChiList[0].ten': {
                        required: "Vui lòng nhập tên người nhận.",
                        minlength: "Tên người nhận phải có ít nhất 2 ký tự.",
                        noWhitespace: "Tên không được chứa khoảng trắng liên tiếp hoặc khoảng trắng ở đầu/cuối.",
                        noSpecialChars: "Tên không được chứa ký tự đặc biệt."
                    },
                    'diaChiList[0].sdt': {
                        required: "Vui lòng nhập số điện thoại.",
                        digits: "Số điện thoại chỉ chứa các ký tự số.",
                        minlength: "Số điện thoại phải có ít nhất 10 ký tự.",
                        maxlength: "Số điện thoại không được vượt quá 15 ký tự."
                    }
                },
                errorElement: "div",
                errorPlacement: function(error, element) {
                    error.addClass("text-red-500 text-sm mt-1");
                    error.insertAfter(element);
                }
            });
        });
    </script>

    <script>
        function closeAlert(alertId) {
            var alertElement = document.getElementById(alertId);
            if (alertElement) {
                alertElement.style.display = 'none';
            }
        }
    </script>

    <script>
        function closeAlert(alertId) {
            var alertElement = document.getElementById(alertId);
            if (alertElement) {
                alertElement.style.display = 'none';
            }
        }

        // Tự động ẩn thông báo sau 3 giây (3000 milliseconds)
        setTimeout(function() {
            closeAlert('successAlert');
        }, 3000);

        setTimeout(function() {
            closeAlert('dangerAlert');
        }, 3000);
    </script>

</head>
<body>
<div layout:fragment="admincontent">

    <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert" id="successAlert">
        <span th:text="${message}"></span>
        <button type="button" class="close" aria-label="Close" onclick="closeAlert('successAlert')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <div th:if="${message1}" class="alert alert-danger alert-dismissible fade show" role="alert" id="dangerAlert">
        <span th:text="${message1}"></span>
        <button type="button" class="close" aria-label="Close" onclick="closeAlert('dangerAlert')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>


    <div th:if="${messageError}" class="alert alert-danger">
        <p th:text="${messageError}"></p>
    </div>
    <div class="mb-6 flex justify-between text-center gap-3 sm:flex-row sm:items-center sm:justify-between">
        <h3 class="text-title-md2 font-semibold text-black dark:text-white"
            th:text="${khachHang.khachHangId == null} ? 'Thêm Khách Hàng' : 'Chi Tiết Khách Hàng'">
        </h3>
        <div class="btn btn-sm bg-sky-50 hover:bg-sky-100 text-sky-800">
            <a th:href="@{/admin/taikhoan/khachhang}" class="custom-button">Quay lại</a>
        </div>
    </div>
    <section class="relative md:py-10 bg-white px-25">
        <div class="grid lg:grid-cols-12 gap-6 w-full">
            <div class="lg:col-span-8">
                <div class="p-6 rounded-md">
                    <form th:action="@{/admin/taikhoan/khachhang/updateDiaChi}" th:object="${khachHang}"
                          onsubmit="return confirm('Bạn có chắc chắn muốn thêm địa chỉ hay chỉnh sửa dữ liệu dưới không?');"
                          method="post">
                        <div class="grid lg:grid-cols-12 grid-cols-1 mt-6 gap-5">
                            <input type="hidden" th:field="*{khachHangId}"/>
                            <div class="lg:col-span-6">
                                <label class="form-label font-semibold">Tên Khách Hàng: </label>
                                <input type="text" th:field="*{hoTen}"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Tên Khách Hàng" readonly>
                                <div th:if="${#fields.hasErrors('hoTen')}" th:errors="*{hoTen}"
                                     class="text-red-500 text-sm mt-1"></div>
                            </div>
                            <div class="lg:col-span-6">
                                <label class="form-label font-semibold">Số Điện Thoại:</label>
                                <input type="text" th:field="*{sdt}"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Số Điện Thoại" readonly>
                                <div th:if="${#fields.hasErrors('sdt')}" th:errors="*{sdt}"
                                     class="text-red-500 text-sm mt-1"></div>
                            </div>
                            <div class="lg:col-span-6">
                                <label class="form-label font-semibold">Email: </label>
                                <input type="email" th:field="*{email}"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Email" readonly>
                                <div th:if="${#fields.hasErrors('email')}" th:errors="*{email}"
                                     class="text-red-500 text-sm mt-1"></div>
                            </div>

                            <div class="lg:col-span-6" style="display: none;">
                                <label class="form-label font-semibold">MatKhau</label>
                                <input type="text" th:field="*{password}"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="password">
                            </div>

                            <div class="lg:col-span-6">
                                <label class="form-label font-semibold">Ngày Sinh: </label>
                                <input type="date" th:field="*{ngaySinh}"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Ngày Sinh" readonly>
                                <div th:if="${#fields.hasErrors('ngaySinh')}" th:errors="*{ngaySinh}"
                                     class="text-red-500 text-sm mt-1"></div>
                            </div>
                            <div class="lg:col-span-12">
                                <label class="form-label font-medium block text-gray-700">Giới tính</label>
                                <div class="mt-1 flex items-center space-x-4 px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                    <label class="inline-flex items-center">
                                        <input type="radio" th:field="*{gioiTinh}" value="false"
                                               class="form-radio text-indigo-600 focus:ring-indigo-500 focus:border-indigo-500"
                                               disabled />
                                        <span class="ml-2">Nữ</span>
                                    </label>
                                    <label class="inline-flex items-center ml-4">
                                        <input type="radio" th:field="*{gioiTinh}" value="true"
                                               class="form-radio text-indigo-600 focus:ring-indigo-500 focus:border-indigo-500"
                                               disabled />
                                        <span class="ml-2">Nam</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <h3 class="text-title-md2 font-semibold mt-12"> Thêm Địa Chỉ</h3>
                        <div class="grid lg:grid-cols-12 grid-cols-1 mt-6 gap-5">
                            <div class="lg:col-span-4">
                                <label class="font-semibold">Thành Phố:</label>
                                <select id="tinh" name="diaChiList[0].thanhPho"
                                        class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2">
                                    <option value="">Tỉnh Thành</option>
                                </select>
                            </div>
                            <div class="lg:col-span-4">
                                <label class="font-semibold">Huyện:</label>
                                <select id="quan" name="diaChiList[0].huyen"
                                        class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2">
                                    <option value="">Quận Huyện</option>
                                </select>
                            </div>
                            <div class="lg:col-span-4">
                                <label class="font-semibold">Xã:</label>
                                <select id="phuong" name="diaChiList[0].xa"
                                        class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2">
                                    <option value="">Phường Xã</option>
                                </select>
                            </div>
                            <div class="lg:col-span-12">
                                <label class="form-label font-semibold">Địa Chỉ: </label>
                                <input type="text" name="diaChiList[0].diaChi"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Địa Chỉ">
                            </div>
                            <div class="lg:col-span-12">
                                <label class="form-label font-semibold">Tên Người Nhận: </label>
                                <input type="text" name="diaChiList[0].ten"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Tên Người Nhận">
                            </div>
                            <div class="lg:col-span-12">
                                <label class="form-label font-semibold">Số điện thoại: </label>
                                <input type="text" name="diaChiList[0].sdt"
                                       class="w-full py-2 px-3 h-10 bg-transparent dark:bg-slate-900 dark:text-slate-200 rounded outline-none border border-gray-100 dark:border-gray-800 focus:ring-0 mt-2"
                                       placeholder="Số điện thoại người nhận">
                            </div>
                            <div class="lg:col-span-12 mt-4 flex items-center justify-center mb-4">
                                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md">Lưu</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>
    <div class="bg-white">
        <table class="table-default table-hover data-table">
            <thead>
            <tr>
                <th>Tên Người Nhận</th>
                <th>Số Điện Thoại Người Nhận</th>
                <th>Tỉnh/Thành Phố</th>
                <th>Quận/Huyện</th>
                <th>Phường/Xã</th>
                <th>Địa Chỉ</th>
                <th>Hành Động</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="diaChi : ${khachHang.diaChiList}">
                <td th:text="${diaChi.ten}"></td>
                <td th:text="${diaChi.sdt}"></td>
                <td th:text="${diaChi.thanhPho}" class="tinhThanhPho"></td>
                <td th:text="${diaChi.huyen}" class="huyenQuan"></td>
                <td th:text="${diaChi.xa}" class="xaPhuong"></td>
                <td th:text="${diaChi.diaChi}"></td>

                <td>
                    <!-- Liên kết xóa với thông báo xác nhận -->
                    <a th:href="@{/admin/taikhoan/diaChi/delete/{id}(id=${diaChi.diaChiId}, khachHangId=${khachHang.khachHangId})}"
                       onclick="return confirm('Bạn có chắc chắn muốn xóa địa chỉ này không?');">Xóa</a>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
</body>
</html>
